<h1>Pace</h1>

<p class="intro">
  Jobs processed by pace reactors. Updated <b><%= pace_info[:updated_at] && distance_of_time_in_words(pace_info[:updated_at], Time.now)  + " ago" || "never" %></b>.
</p>

<table class="queues">
  <tr>
    <th>Name</th>
    <th>Processed</th>
    <th>Last Job</th>
  </tr>
  <% if !pace_info[:queues].empty? %>
    <% pace_info[:queues].each do |name, info| %>
      <tr>
        <td><%= name %></td>
        <td><%= number_with_delimiter(info[:processed]) %></td>
        <td><%= info[:last_job_at] && distance_of_time_in_words(info[:last_job_at], Time.now) + " ago" %></td>
      </tr>
    <% end %>
  <% end %>
  <tr>
    <td>total</td>
    <td><%= pace_info[:processed] && number_with_delimiter(pace_info[:processed]) %></td>
    <td><%= pace_info[:last_job_at] && distance_of_time_in_words(pace_info[:last_job_at], Time.now) + " ago" %></td>
  </tr>
</table>

<br />

<h2 style="color: #777;font-weight: bold;border-bottom: 1px solid #eee">12 hours</h2>
<div id='jobs_per_minute' style="height: 200px"></div>

<br />

<h2 style="color: #777;font-weight: bold;border-bottom: 1px solid #eee">7 Days</h2>
<div id='jobs_per_hour' style="height: 200px"></div>

<hr />

<h1>Workers</h1>
<p class="sub">
  Active within the last minute.
</p>

<table class="workers">
  <tr>
    <th>Worker</th>
    <th>Command</th>
    <th>Processed</th>
    <th>Created</th>
    <th>Updated</th>
  </tr>
  <% if !pace_info[:workers].empty? %>
    <% pace_info[:workers].each do |id, info| %>
      <tr>
        <td><%= id %></td>
        <td><%= info[:command] %></td>
        <td><%= info[:processed] && number_with_delimiter(info[:processed]) %></td>
        <td><%= distance_of_time_in_words(info[:created_at], Time.now) %> ago</td>
        <td><%= info[:updated_at] && distance_of_time_in_words(info[:updated_at], Time.now) + " ago" %></td>
      </tr>
    <% end %>
  <% else %>
    <tr>
      <td colspan="5" class="no-data">No information...</td>
    </tr>
  <% end %>
</table>

<hr />

<h1>Classes</h1>
<p class="sub">
  Distribution of classes processed.
</p>

<table class="queues">
  <tr>
    <th>Class</th>
    <th>Processed</th>
  </tr>

  <% if !pace_info[:classes].empty? %>
    <% pace_info[:classes].each do |name, processed| %>
      <tr>
        <td><%= name %></td>
        <td><%= number_with_delimiter(processed) %></td>
      </tr>
    <% end %>
  <% else %>
    <tr>
      <td colspan="4" class="no-data">No information...</td>
    </tr>
  <% end %>
</table>

<hr />

<% queues = pace_info[:queues].keys %>
<script type='text/javascript' src='https://www.google.com/jsapi'></script>
<script type='text/javascript'>
  google.load('visualization', '1', {packages:['imagelinechart']});
  google.setOnLoadCallback(drawMinuteChart);
  google.setOnLoadCallback(drawHourChart);

  // 12 hours, by minute
  function drawMinuteChart() {
    var data = new google.visualization.DataTable({
      cols: [<%= Pace::Stats.google_chart_cols(queues) %>],
      rows: [<%= Pace::Stats.google_chart_rows(queues) %>]
    });
    var chart = new google.visualization.ImageLineChart(document.getElementById('jobs_per_minute'));
    chart.draw(data, {width: 800, height: 200, min: 0});
  }

  // 7 days, by hour
  function drawHourChart() {
    var data = new google.visualization.DataTable({
      cols: [<%= Pace::Stats.google_chart_cols(queues) %>],
      rows: [<%= Pace::Stats.google_chart_rows(queues, :hour) %>]
    });
    var chart = new google.visualization.ImageLineChart(document.getElementById('jobs_per_hour'));
    chart.draw(data, {width: 800, height: 200, min: 0});
  }
</script>
